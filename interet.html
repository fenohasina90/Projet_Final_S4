<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intérêts par Mois</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/interet.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <a href="index.html" class="navbar-logo">Gestion Prêts</a>
      <div class="navbar-links">
        <a href="index.html">Accueil</a>
        <a href="pretForm.html">Créer un prêt</a>
        <a href="validation_pret.html">Validation</a>
        <a href="historique_pret.html">Historique</a>
        <a href="simulation.html">Simulation</a>
        <a href="interet.html">Intérêts</a>
        <a href="create_type_pret.html">Types de prêts</a>
      </div>
    </div>
  </nav>
  <div class="container">
    <div class="interet-container">
        <div class="interet-header">
            <h2>Intérêts Gagnés par Mois</h2>
            <p>Analysez les intérêts gagnés sur une période donnée</p>
        </div>

    <div class="date-controls">
        <label for="date1">Date Début :</label>
        <input type="date" id="date1">

        <label for="date2">Date Fin :</label>
        <input type="date" id="date2">

        <button onclick="getInteret()">Afficher</button>
    </div>

    <div id="message"></div>

    <div class="chart-section">
        <div class="chart-header">
            <h3>Graphique des Intérêts</h3>
        </div>
        <div id="chart-container" class="chart-container">
            <canvas id="interetChart"></canvas>
        </div>
    </div>

    <table id="table-interet" class="interet-table">
        <thead>
            <tr>
                <th>Mois</th>
                <th>Année</th>
                <th>Intérêt Gagné</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Conteneur pour le graphique -->
    <div id="chart-container">
        <canvas id="interetChart"></canvas>
    </div>

    <script>
        const apiBase = "http://localhost/Projet_Final_S4/ws";
        let chartInstance = null;

        function ajax(method, url, data, callback) {
            const xhr = new XMLHttpRequest();
            xhr.open(method, apiBase + url, true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        callback(JSON.parse(xhr.responseText));
                    } else {
                        alert("Erreur " + xhr.status + " : " + xhr.responseText);
                    }
                }
            };
            xhr.send(data);
        }

        function getInteret() {
            const date1 = document.getElementById("date1").value;
            const date2 = document.getElementById("date2").value;
            
            if (!date1 || !date2) {
                showMessage("Veuillez sélectionner les deux dates", "error");
                return;
            }
            
            if (date1 > date2) {
                showMessage("La date de début doit être antérieure à la date de fin", "error");
                return;
            }
            
            const url = `/interet?date1=${encodeURIComponent(date1)}&date2=${encodeURIComponent(date2)}`;

            ajax("GET", url, null, (response) => {
                const tbody = document.querySelector("#table-interet tbody");
                tbody.innerHTML = ""; // Clear table

                const labels = [];
                const data = [];

                if (response.length === 0) {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = "Aucune donnée";
                    row.insertCell();
                    row.insertCell();
                    showMessage("Aucun intérêt trouvé pour cette période", "info");
                } else {
                    response.forEach(entry => {
                        const row = tbody.insertRow();
                        let mois = "-", annee = "-";
                        if (entry.periode) {
                            const [anneeVal, moisVal] = entry.periode.split('-');
                            mois = moisVal;
                            annee = anneeVal;
                        }
                        row.insertCell().textContent = mois;
                        row.insertCell().textContent = annee;
                        const interetVal = Number(entry.interet_gagne) || 0;
                        row.insertCell().textContent = interetVal.toFixed(2) + " Ar";

                        labels.push(`${mois}/${annee}`);
                        data.push(interetVal);
                    });

                    drawChart(labels, data);
                    showMessage(`${response.length} mois d'intérêts trouvés`, "success");
                }
            });
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            // Supprimer les anciennes classes
            messageDiv.className = '';
            
            // Ajouter la classe appropriée
            if (type === 'error') {
                messageDiv.style.backgroundColor = '#ffebee';
                messageDiv.style.color = '#c62828';
                messageDiv.style.border = '1px solid #ffcdd2';
            } else if (type === 'success') {
                messageDiv.style.backgroundColor = '#e8f5e8';
                messageDiv.style.color = '#2e7d32';
                messageDiv.style.border = '1px solid #c8e6c9';
            } else {
                messageDiv.style.backgroundColor = '#e3f2fd';
                messageDiv.style.color = '#1565c0';
                messageDiv.style.border = '1px solid #bbdefb';
            }
        }


        </script>
        <script src="interet.js" defer></script>
        </div>
    </div>
</body>
</html>
