<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Validation des Prêts</title>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/validation_pret.css">
</head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <a href="index.html" class="navbar-logo">Gestion Banque</a>
      <div class="navbar-links">
        <a href="index.html">Accueil</a>
        <a href="pretForm.html">Créer un prêt</a>
        <a href="validation_pret.html">Validation</a>
        <a href="historique_pret.html">Historique</a>
        <a href="simulation.html">Simulation</a>
        <a href="interet.html">Intérêts</a>
        <a href="create_type_pret.html">Types de prêts</a>
        <a href="ajout_fond.html">Ajout Fonds</a>
        <a href="simulation_enregistrement.html">Enregistrer Simulation</a>
        <a href="disponibilite_ef.html">Disponibilité EF</a>
      </div>
    </div>
  </nav>
  <button class="sidebar-toggle" onclick="toggleSidebar()">☰</button>
  <nav class="sidebar" id="sidebar">
    <a href="index.html" class="sidebar-logo">Gestion Prêts</a>
    <div class="sidebar-links">
      <a href="index.html">Accueil</a>
      <a href="pretForm.html">Créer un prêt</a>
      <a href="validation_pret.html">Validation</a>
      <a href="historique_pret.html">Historique</a>
      <a href="simulation.html">Simulation</a>
      <a href="interet.html">Intérêts</a>
      <a href="create_type_pret.html">Types de prêts</a>
      <a href="views/fonds/ajout.html">Fonds</a>
      <a href="ajout_fond.html">Ajout Fonds</a>
      <a href="disponibilite_ef.html">Disponibilité EF</a>
    </div>
  </nav>
  <div class="container">
    <div class="validation-container">
      <div class="validation-header">
        <h2>Validation des Prêts</h2>
        <p>Validez et approuvez les demandes de prêts en attente</p>
      </div>
      <div class="filter-section">
        <label>Filtrer par client :</label>
        <select id="filter-client">
          <option value="">Tous les clients</option>
        </select>
        <button onclick="loadPrets()">Filtrer</button>
      </div>
      <table id="prets-table">
        <thead>
          <tr>
            <th>ID Prêt</th>
            <th>Client</th>
            <th>Type de Prêt</th>
            <th>Montant</th>
            <th>Durée (mois)</th>
            <th>Taux (%)</th>
            <th>Assurance</th>
            <th>Délai (mois)</th>
            <th>Date de début</th>
            <th>Début remboursement</th>
            <th>Statut</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="prets-tbody">
        </tbody>
      </table>
      <div id="message"></div>
    </div>
  </div>
  <script>
    function toggleSidebar() {
      var sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('open');
    }
    const apiBase = "http://localhost/Final/Projet_Final_S4/ws/ws";
    let allPrets = [];
    let allClients = [];

    function ajax(method, url, data, callback) {
      const xhr = new XMLHttpRequest();
      xhr.open(method, apiBase + url, true);
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            callback(JSON.parse(xhr.responseText));
          } else {
            document.getElementById('message').textContent = "Erreur lors de la requête";
          }
        }
      };
      xhr.send(data);
    }

    // Charger les clients pour le filtre
    function loadClients() {
      ajax("GET", "/clients", null, (response) => {
        allClients = response;
        const select = document.getElementById('filter-client');
        select.innerHTML = '<option value="">Tous les clients</option>';
        response.forEach(client => {
          const option = document.createElement('option');
          option.value = client.client_id;
          option.textContent = client.nom;
          select.appendChild(option);
        });
      });
    }

    // Charger tous les prêts
    function loadPrets() {
      ajax("GET", "/prets", null, (response) => {
        allPrets = response;
        displayPrets(response);
      });
    }

    // Afficher les prêts avec filtre
    function displayPrets(prets) {
      const filterClient = document.getElementById('filter-client').value;
      let filteredPrets = prets;
      
      if (filterClient) {
        filteredPrets = prets.filter(pret => pret.client_id == filterClient);
      }

      const tbody = document.getElementById('prets-tbody');
      tbody.innerHTML = '';

      filteredPrets.forEach(pret => {
        const row = tbody.insertRow();
        // Calculer la date de début de remboursement
        const dateDebut = new Date(pret.date_debut);
        const dateDebutRemboursement = new Date(dateDebut);
        dateDebutRemboursement.setMonth(dateDebutRemboursement.getMonth() + (pret.mois_delai || 0));
        
        row.innerHTML = `
          <td>${pret.pret_id}</td>
          <td>${getClientName(pret.client_id)}</td>
          <td>${getTypePretName(pret.type_pret_id)}</td>
          <td>${pret.montant} Ar</td>
          <td>${pret.duree_mois}</td>
          <td>${pret.taux_applique}%</td>
          <td>${pret.assurance}</td>
          <td>
            ${pret.statut === 'En attente' ? 
              `<input type="number" id="mois_delai_${pret.pret_id}" value="${pret.mois_delai || 0}" min="0" style="width: 60px;">` : 
              `${pret.mois_delai || 0}`
            }
          </td>
          <td>${pret.date_debut}</td>
          <td>${dateDebutRemboursement.toLocaleDateString('fr-FR')}</td>
          <td class="status-${pret.statut === 'En attente' ? 'pending' : 'approved'}">${pret.statut}</td>
          <td>
            ${pret.statut === 'En attente' ? 
              `<button class="btn-approve" onclick="approvePret(${pret.pret_id})">Approuver</button>
               <button class="btn-update" onclick="updatePret(${pret.pret_id})">Modifier</button>` : 
              'Déjà approuvé'
            }
          </td>
        `;
      });
    }

    // Obtenir le nom du client
    function getClientName(clientId) {
      const client = allClients.find(c => c.client_id == clientId);
      return client ? client.nom : 'Client inconnu';
    }

    // Obtenir le nom du type de prêt
    function getTypePretName(typePretId) {
      // On pourrait charger les types de prêt aussi, pour l'instant on affiche l'ID
      return `Type ${typePretId}`;
    }

    // Approuver un prêt
    function approvePret(pretId) {
      const moisDelai = document.getElementById(`mois_delai_${pretId}`).value;
      if (confirm('Êtes-vous sûr de vouloir approuver ce prêt ?')) {
        const data = `pret_id=${encodeURIComponent(pretId)}&statut=Approuvé&mois_delai=${encodeURIComponent(moisDelai)}`;
        ajax("POST", "/approve-pret", data, (response) => {
          if (response.success) {
            document.getElementById('message').textContent = "Prêt approuvé avec succès !";
            loadPrets(); // Recharger la liste
          } else {
            document.getElementById('message').textContent = "Erreur lors de l'approbation : " + response.message;
          }
        });
      }
    }


    function updatePret(pretId) {
      const moisDelai = document.getElementById(`mois_delai_${pretId}`).value;
      
      if (moisDelai === '' || moisDelai < 0) {
        alert('Veuillez entrer un délai valide (nombre positif)');
        return;
      }

      if (confirm('Êtes-vous sûr de vouloir modifier ce prêt ?')) {
        const data = `pret_id=${encodeURIComponent(pretId)}&mois_delai=${encodeURIComponent(moisDelai)}`;
        ajax("POST", "/update-pret", data, (response) => {
          if (response.success) {
            document.getElementById('message').textContent = "Prêt modifié avec succès !";
            loadPrets(); // Recharger la liste
          } else {
            document.getElementById('message').textContent = "Erreur lors de la modification : " + response.message;
          }
        });
      }
    }

    // Initialisation au chargement de la page
    window.onload = function() {
      loadClients();
      loadPrets();
    };
  </script>
</body>
</html> 